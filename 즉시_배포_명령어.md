# 🚨 즉시 배포 명령어 - CSP blob: 문제 해결

## 📋 **현재 상황**
- 배포된 웹 앱에서 `blob:` URL이 여전히 차단됨
- CSP 에러: `img-src 'self' data: https:` (blob: 누락)
- 즉시 수정이 필요한 상황

## 🚀 **즉시 실행할 명령어들**

### 1. **배포 서버에 접속**
```bash
# 배포 서버 (210.117.181.115)에 SSH 접속
ssh user@210.117.181.115
```

### 2. **기존 컨테이너 중지**
```bash
# 현재 실행 중인 웹 컨테이너 중지
docker-compose down
# 또는
docker stop heritage-web
```

### 3. **새로운 파일들 업로드**
```bash
# csp_fix_deploy.tar.gz 파일을 서버에 업로드한 후:
tar -xzf csp_fix_deploy.tar.gz

# 웹 앱 파일 복사
cp -r my_cross_app/build/web/* /path/to/your/web/directory/

# Nginx 설정 복사
cp nginx.conf /etc/nginx/conf.d/default.conf
# 또는 Docker 볼륨에 복사
```

### 4. **Nginx 설정 강제 적용**
```bash
# Nginx 설정 테스트
nginx -t

# Nginx 재시작
systemctl restart nginx
# 또는 Docker 컨테이너 재시작
docker-compose up -d heritage-web
```

### 5. **즉시 테스트**
```bash
# 웹 앱 접속 후 강제 새로고침
# http://210.117.181.115:3001/#/home
# Ctrl+Shift+R (캐시 삭제)
```

## 🔧 **Docker Compose 사용 시**

### A. 전체 재배포
```bash
cd /home/carrotsw/heritage_services_app
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### B. 웹 앱만 재배포
```bash
# 웹 컨테이너만 재빌드
docker-compose build --no-cache heritage-web
docker-compose up -d heritage-web

# 로그 확인
docker-compose logs heritage-web
```

## 🎯 **성공 확인 방법**

### 1. **브라우저 개발자 도구**
- F12 → Console 탭
- CSP 에러가 사라졌는지 확인
- `blob:` URL이 `(blocked:csp)` 없이 로드되는지 확인

### 2. **Network 탭 확인**
- `blob:` 요청이 정상적으로 로드되는지 확인
- Status가 `200` 또는 정상 상태인지 확인

### 3. **이미지 표시 확인**
- 문화유산 사진이 깨진 아이콘 대신 실제 사진이 표시되는지 확인

## 🚨 **여전히 문제가 있다면**

### 1. **강력한 CSP 우회 (임시)**
```nginx
# nginx.conf에 추가
add_header Content-Security-Policy "default-src *; img-src *; media-src *; script-src *; style-src *; font-src *;" always;
```

### 2. **CSP 완전 비활성화 (임시)**
```nginx
# nginx.conf에서 CSP 헤더 제거
# add_header Content-Security-Policy ... 줄을 주석 처리
```

### 3. **캐시 완전 삭제**
```bash
# 브라우저에서:
# 1. Ctrl+Shift+Delete
# 2. "모든 시간" 선택
# 3. "캐시된 이미지 및 파일" 체크
# 4. 삭제 후 재접속
```

## 📁 **배포 파일 목록**

- ✅ `csp_fix_deploy.tar.gz` - 수정된 웹 앱 + Nginx 설정
- ✅ `my_cross_app/build/web/index.html` - blob: 포함된 CSP 설정
- ✅ `nginx.conf` - 강화된 CSP 헤더 설정
- ✅ `docker-compose.yml` - 컨테이너 설정

## ⚡ **즉시 실행 순서**

1. **서버 접속** → `ssh user@210.117.181.115`
2. **컨테이너 중지** → `docker-compose down`
3. **파일 업로드** → `csp_fix_deploy.tar.gz` 업로드 및 압축 해제
4. **설정 적용** → Nginx 설정 복사 및 재시작
5. **컨테이너 재시작** → `docker-compose up -d`
6. **테스트** → 브라우저에서 `Ctrl+Shift+R` 후 이미지 확인

이제 `blob:` URL이 정상적으로 로드될 것입니다! 🎉
