# 🔧 이미지 로딩 문제 해결 가이드

## 문제 상황
- 문화유산 현황 사진이 깨진 이미지 아이콘으로 표시됨
- 실제 사진은 Firebase Storage에 저장되어 있음
- 크롬 브라우저에서 이미지가 로드되지 않음

## 원인 분석
1. **Firebase Storage CORS 정책**: 브라우저에서 Firebase Storage에 직접 접근할 때 CORS 오류 발생
2. **이미지 URL 유효성**: Firebase Storage URL이 올바르게 생성되지 않았을 가능성
3. **네트워크 권한**: Firebase Storage 접근 권한 설정 문제

## 해결 방법

### 1. Firebase Storage CORS 설정 (권장)

#### 방법 A: gsutil 사용
```bash
# 1. Google Cloud SDK 설치 (gsutil 포함)
# https://cloud.google.com/sdk/docs/install

# 2. Firebase 프로젝트에 인증
gcloud auth login

# 3. CORS 설정 적용
gsutil cors set firebase_storage_cors.json gs://heritageservices-23a6c.appspot.com
```

#### 방법 B: Firebase CLI 사용
```bash
# 1. Firebase CLI 설치
npm install -g firebase-tools

# 2. 로그인
firebase login

# 3. 프로젝트 설정
firebase use heritageservices-23a6c

# 4. CORS 설정 적용 (스크립트 실행)
./setup_firebase_cors.sh
```

### 2. Firebase Storage 보안 규칙 확인

Firebase Console → Storage → Rules에서 다음 규칙이 설정되어 있는지 확인:

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read: if true;  // 임시로 모든 읽기 허용
      allow write: if request.auth != null;  // 인증된 사용자만 쓰기 허용
    }
  }
}
```

### 3. 이미지 URL 디버깅

브라우저 개발자 도구에서 다음을 확인:

1. **Network 탭**: 이미지 요청이 실패하는지 확인
2. **Console 탭**: CORS 오류 메시지 확인
3. **이미지 URL 직접 접근**: 새 탭에서 URL을 직접 열어보기

### 4. 대체 해결 방법

#### A. Firebase Storage 대신 로컬 서버 사용
```dart
// lib/services/firebase_service.dart 수정
Future<String> uploadImage(...) async {
  // Firebase Storage 대신 로컬 서버에 업로드
  final response = await http.post(
    Uri.parse('${Env.proxyBase}/upload'),
    body: bytes,
    headers: {'Content-Type': 'image/jpeg'},
  );
  return response.body; // 서버에서 반환한 URL
}
```

#### B. Base64 인코딩 사용
```dart
// 이미지를 Base64로 인코딩하여 Firestore에 저장
final base64Image = base64Encode(bytes);
await _fs.collection('photos').add({
  'imageData': base64Image,
  'contentType': 'image/jpeg',
});
```

### 5. 임시 해결책

현재 상황에서 즉시 해결하려면:

1. **브라우저 캐시 삭제**: Ctrl+Shift+R (강제 새로고침)
2. **다른 브라우저 시도**: Firefox, Safari 등
3. **개발자 도구에서 네트워크 탭 확인**: 실제 오류 메시지 확인

## 확인 방법

### 1. CORS 설정 확인
```bash
# CORS 설정이 적용되었는지 확인
gsutil cors get gs://heritageservices-23a6c.appspot.com
```

### 2. 이미지 URL 테스트
```bash
# 터미널에서 이미지 URL 직접 테스트
curl -I "https://firebasestorage.googleapis.com/..."
```

### 3. Firebase Storage 접근 테스트
```javascript
// 브라우저 콘솔에서 테스트
fetch('https://firebasestorage.googleapis.com/...')
  .then(response => console.log('Success:', response))
  .catch(error => console.log('Error:', error));
```

## 예상 결과

CORS 설정 적용 후:
- ✅ 이미지가 정상적으로 표시됨
- ✅ 로딩 인디케이터가 표시됨
- ✅ 에러 발생 시 명확한 메시지 표시

## 추가 문제 해결

### Firebase Storage 권한 문제
```javascript
// Firebase Console → Storage → Rules
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /heritages/{heritageId}/{folder}/{allPaths=**} {
      allow read, write: if true;  // 개발용 - 프로덕션에서는 제한 필요
    }
  }
}
```

### 네트워크 문제
- 방화벽 설정 확인
- 프록시 서버 사용 시 설정 확인
- VPN 사용 시 Firebase 접근 가능 여부 확인

## 프로덕션 환경 고려사항

1. **보안 규칙 강화**: 인증된 사용자만 접근 허용
2. **CDN 사용**: Firebase Storage + Cloud CDN 조합
3. **이미지 최적화**: WebP 포맷 사용, 리사이징 등
4. **캐싱 전략**: 적절한 Cache-Control 헤더 설정
