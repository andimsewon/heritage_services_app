# 🚀 배포 환경 이미지 문제 해결 가이드

## 📋 **현재 상황**
- 배포된 웹 앱: `http://210.117.181.115:3001/#/home`
- 이미지가 깨져서 표시되는 문제 발생
- 원인: `PROXY_BASE`가 `localhost:8080`으로 설정되어 있음

## 🔧 **해결 방법**

### 1. **배포된 서버에 이미지 프록시 기능 추가**

배포된 서버 (`210.117.181.115`)에 다음 파일들을 업로드하고 설정하세요:

#### A. 서버 코드 업데이트
```bash
# 1. 서버 디렉토리에 다음 파일들 추가:
# - server/image/router.py (이미지 프록시 라우터)
# - server/image/__init__.py
# - server/main.py (업데이트된 버전)

# 2. requirements.txt에 httpx가 포함되어 있는지 확인
# 3. 서버 재시작
python3 -m uvicorn main:app --host 0.0.0.0 --port 8080 --reload
```

#### B. 이미지 프록시 엔드포인트 확인
```bash
# 다음 URL들이 정상 작동하는지 확인:
curl http://210.117.181.115:8080/health
curl http://210.117.181.115:8080/image/proxy/health
curl http://210.117.181.115:8080/image/proxy/info
```

### 2. **Flutter 웹 앱 재배포**

#### A. 새로운 빌드 파일 생성 (이미 완료됨)
```bash
# 로컬에서 이미 실행됨:
flutter build web --dart-define=PROXY_BASE=http://210.117.181.115:8080
```

#### B. 배포된 웹 서버에 새 빌드 파일 업로드
```bash
# build/web 디렉토리의 모든 파일을 
# 210.117.181.115:3001에서 서비스되는 웹 서버 디렉토리에 업로드
```

### 3. **Firebase Storage CORS 설정 (선택사항)**

만약 여전히 문제가 있다면 Firebase Storage CORS 설정을 적용하세요:

```bash
# 배포 서버에서 실행:
# 1. Firebase CLI 설치
npm install -g firebase-tools

# 2. Firebase 로그인
firebase login

# 3. CORS 설정 적용
gsutil cors set firebase_storage_cors.json gs://heritageservices-23a6c.appspot.com
```

## 🧪 **테스트 방법**

### 1. **이미지 프록시 직접 테스트**
```bash
# Firebase Storage URL이 있다면:
curl "http://210.117.181.115:8080/image/proxy?url=<FIREBASE_STORAGE_URL>"
```

### 2. **웹 앱에서 테스트**
1. `http://210.117.181.115:3001/#/home` 접속
2. `Ctrl+Shift+R`로 강제 새로고침 (캐시 삭제)
3. 문화유산 선택 후 사진 등록
4. 이미지가 정상적으로 표시되는지 확인

### 3. **브라우저 개발자 도구 확인**
- F12 → Network 탭에서 이미지 요청 상태 확인
- Console 탭에서 에러 메시지 확인

## 📁 **배포할 파일들**

### 서버 파일 (heritage_services_app_deploy.tar.gz)
- `server/image/router.py` - 이미지 프록시 라우터
- `server/image/__init__.py`
- `server/main.py` - 업데이트된 메인 파일
- `firebase_storage_cors.json` - CORS 설정
- `setup_firebase_cors.sh` - 자동 설정 스크립트

### 웹 앱 파일 (build/web/)
- `build/web/` 디렉토리의 모든 파일
- `PROXY_BASE=http://210.117.181.115:8080`으로 빌드됨

## ✅ **성공 기준**

- ✅ 이미지가 깨진 아이콘 대신 실제 사진이 표시됨
- ✅ 이미지 로딩 시 진행 표시기가 나타남
- ✅ 에러 발생 시 명확한 에러 메시지 표시

## 🚨 **문제 해결**

### 여전히 이미지가 깨진다면:
1. **서버 로그 확인**: `210.117.181.115:8080`에서 이미지 프록시가 정상 작동하는지 확인
2. **네트워크 확인**: 브라우저 개발자 도구에서 이미지 요청이 `210.117.181.115:8080/image/proxy`로 가는지 확인
3. **Firebase Storage 권한**: Firebase Console에서 Storage 보안 규칙 확인

### 로그 확인 명령어:
```bash
# 서버 로그 확인
tail -f /var/log/nginx/error.log
# 또는
journalctl -u your-service-name -f
```
