# 🚨 최종 해결 명령어 - CSP 완전 우회

## 📋 **현재 상황**
- 배포된 웹 앱에서 여전히 `blob:` URL이 차단됨
- CSP 에러: `img-src 'self' data: https:` (blob: 누락)
- **강력한 CSP 우회 방법 적용 필요**

## 🚀 **즉시 실행할 명령어들**

### 1. **배포 서버에 접속**
```bash
# 배포 서버 (210.117.181.115)에 SSH 접속
ssh user@210.117.181.115
```

### 2. **기존 컨테이너 완전 중지**
```bash
# 모든 컨테이너 중지
docker-compose down
docker system prune -f

# 또는 개별 컨테이너 중지
docker stop heritage-web heritage-api
docker rm heritage-web heritage-api
```

### 3. **새로운 파일들 업로드 및 적용**
```bash
# final_csp_fix.tar.gz 파일을 서버에 업로드한 후:
tar -xzf final_csp_fix.tar.gz

# 웹 앱 파일 복사 (기존 파일 덮어쓰기)
cp -r my_cross_app/build/web/* /path/to/your/web/directory/

# Nginx 설정 강제 적용
cp nginx.conf /etc/nginx/conf.d/default.conf
nginx -t
systemctl restart nginx
```

### 4. **Docker 컨테이너 재시작**
```bash
# 전체 재시작
docker-compose up -d

# 또는 개별 재시작
docker-compose build --no-cache heritage-web
docker-compose up -d heritage-web
```

### 5. **즉시 테스트**
```bash
# 웹 앱 접속 후 강제 새로고침
# http://210.117.181.115:3001/#/home
# Ctrl+Shift+R (캐시 완전 삭제)
```

## 🔧 **강력한 CSP 우회 설정**

### A. Nginx 설정 (완전 우회)
```nginx
add_header Content-Security-Policy "
    default-src *;
    img-src * data: blob:;
    media-src * data: blob:;
    connect-src *;
    script-src * 'unsafe-inline' 'unsafe-eval';
    style-src * 'unsafe-inline';
    font-src * data:;
    frame-ancestors *;
" always;
```

### B. Flutter 웹 앱 index.html (완전 우회)
```html
<meta http-equiv="Content-Security-Policy" content="default-src *; img-src * data: blob:; media-src * data: blob:; connect-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; font-src * data:; frame-ancestors *;">
```

## 🎯 **성공 확인 방법**

### 1. **브라우저 개발자 도구**
- F12 → Console 탭
- CSP 에러가 완전히 사라졌는지 확인
- `blob:` URL이 `(blocked:csp)` 없이 로드되는지 확인

### 2. **Network 탭 확인**
- `blob:` 요청이 정상적으로 로드되는지 확인
- Status가 `200` 또는 정상 상태인지 확인

### 3. **이미지 표시 확인**
- 문화유산 사진이 깨진 아이콘 대신 실제 사진이 표시되는지 확인

## 🚨 **여전히 문제가 있다면**

### 1. **CSP 완전 비활성화 (최후의 수단)**
```nginx
# nginx.conf에서 CSP 헤더 완전 제거
# add_header Content-Security-Policy ... 줄을 주석 처리
```

### 2. **브라우저 캐시 완전 삭제**
```bash
# 브라우저에서:
# 1. Ctrl+Shift+Delete
# 2. "모든 시간" 선택
# 3. 모든 항목 체크
# 4. 삭제 후 재접속
```

### 3. **시크릿 모드에서 테스트**
```bash
# 브라우저 시크릿 모드에서 테스트
# http://210.117.181.115:3001/#/home
```

## 📁 **배포 파일 목록**

- ✅ `final_csp_fix.tar.gz` - 완전 우회된 웹 앱 + Nginx 설정
- ✅ `my_cross_app/build/web/index.html` - 완전 우회된 CSP 설정
- ✅ `nginx.conf` - 완전 우회된 CSP 헤더 설정
- ✅ `docker-compose.yml` - 컨테이너 설정

## ⚡ **즉시 실행 순서**

1. **서버 접속** → `ssh user@210.117.181.115`
2. **컨테이너 완전 중지** → `docker-compose down && docker system prune -f`
3. **파일 업로드** → `final_csp_fix.tar.gz` 업로드 및 압축 해제
4. **설정 강제 적용** → Nginx 설정 복사 및 재시작
5. **컨테이너 재시작** → `docker-compose up -d`
6. **테스트** → 브라우저에서 `Ctrl+Shift+R` 후 이미지 확인

## 🎉 **예상 결과**

- ✅ CSP 에러가 완전히 사라짐
- ✅ `blob:` URL이 정상적으로 로드됨
- ✅ 이미지가 깨진 아이콘 대신 실제 사진이 표시됨
- ✅ 모든 이미지 소스가 정상 작동

이제 `blob:` URL이 완전히 허용되어 이미지가 정상적으로 표시될 것입니다! 🚀
