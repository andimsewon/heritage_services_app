<!DOCTYPE html>
<html>

<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- 🔥 캐시 완전 무효화 (브라우저 강제 리로드) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- 웹에서 파일 업로드를 위한 추가 메타 태그 -->
  <!-- ✅ 뷰포트 설정 (화면 배율 100% 지원) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta http-equiv="Content-Security-Policy"
    content="default-src *; img-src * data: blob:; media-src * data: blob:; connect-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; font-src * data:; script-src-elem * 'unsafe-inline' 'unsafe-eval';">

  <!-- 시스템 폰트 사용으로 폰트 로딩 오류 방지 -->
  <style>
    /* 🔥 화면 크기 100% 강제 적용 - 스크롤 허용 (최대한 강력한 설정) */
    html {
      height: 100vh !important;
      width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: auto !important;
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      min-height: 100vh !important;
      min-width: 100vw !important;
      max-width: none !important;
      max-height: none !important;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      height: 100vh !important;
      width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: auto !important;
      background-color: #f5f7fa !important;
      position: relative !important;
      min-height: 100vh !important;
      min-width: 100vw !important;
    }

    /* Flutter 웹에서 폰트 로딩 오류 방지 */
    * {
      font-family: inherit;
    }

    /* ✅ Flutter 루트 요소들 100% 크기 강제 (더 강력한 설정) */
    flt-glass-pane,
    flt-scene-host,
    flt-platform-view,
    flutter-view {
      width: 100vw !important;
      height: 100vh !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      overflow: visible !important;
      min-height: 100vh !important;
      min-width: 100vw !important;
      max-width: none !important;
      max-height: none !important;
    }

    /* Flutter 앱 컨테이너 (최대한 강력한 설정) */
    #flutter-container {
      width: 100vw !important;
      height: 100vh !important;
      min-height: 100vh !important;
      min-width: 100vw !important;
      max-width: none !important;
      max-height: none !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }

    /* 🔥 추가 강력한 반응형 규칙 */
    html[style*="width"],
    html[style*="height"] {
      width: 100vw !important;
      height: 100vh !important;
    }

    flutter-view[style*="width"],
    flutter-view[style*="height"] {
      width: 100vw !important;
      height: 100vh !important;
    }

    /* 모든 Flutter 관련 요소 강제 반응형 */
    flt-glass-pane[style*="width"],
    flt-glass-pane[style*="height"],
    flt-scene-host[style*="width"],
    flt-scene-host[style*="height"],
    flt-platform-view[style*="width"],
    flt-platform-view[style*="height"] {
      width: 100vw !important;
      height: 100vh !important;
    }
  </style>

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="my_cross_app">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <title>Heritage Services App</title>
  <link rel="manifest" href="manifest.json">

  <!-- Firebase SDK (Analytics 제거) -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAg4BcMA1qeRgQfV9pTxbeiwSeo4vSiP18",
      authDomain: "heritageservices-23a6c.firebaseapp.com",
      projectId: "heritageservices-23a6c",
      storageBucket: "heritageservices-23a6c.firebasestorage.app",
      messagingSenderId: "661570902154",
      appId: "1:661570902154:web:17d16562436aa476da3573"
    };

    // Initialize Firebase (Analytics 제거)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Firebase 연결 설정 개선
    console.log('🔥 Firebase 초기화 완료');

    // 연결 상태 모니터링
    db.enableNetwork().then(() => {
      console.log('✅ Firestore 네트워크 연결 활성화');
    }).catch((error) => {
      console.error('❌ Firestore 네트워크 연결 실패:', error);
    });

    // 전역 변수로 설정 (Flutter에서 접근 가능)
    window.firebaseApp = app;
    window.firebaseDb = db;
    window.firebaseStorage = storage;
  </script>
  <!-- ✅ Service Worker 완전 비활성화 (HTTP 환경 지원) -->
  <script>
    console.log('🔥 캐시 클리어 시작...');

    // 1. 기존 Service Worker 모두 제거
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations()
        .then((registrations) => {
          if (registrations.length > 0) {
            console.log(`🗑️ ${registrations.length}개 Service Worker 삭제 중...`);
          }
          registrations.forEach((registration) => {
            registration.unregister()
              .then(() => console.log('✅ Service Worker 삭제됨'))
              .catch((err) => console.warn('⚠️ Service worker unregister failed:', err));
          });
        })
        .catch((err) => console.warn('Service worker lookup failed:', err));
    }

    // 1-1. 모든 캐시 스토리지 삭제 (CanvasKit wasm 캐시 포함)
    if ('caches' in window) {
      caches.keys().then(cacheNames => {
        if (cacheNames.length > 0) {
          console.log(`🗑️ ${cacheNames.length}개 캐시 삭제 중...`);
          return Promise.all(
            cacheNames.map(cacheName => {
              console.log(`  - 삭제: ${cacheName}`);
              return caches.delete(cacheName);
            })
          );
        }
      }).then(() => {
        console.log('✅ 모든 캐시 삭제 완료');
      }).catch(err => console.warn('⚠️ 캐시 삭제 실패:', err));
    }

    // 2. Service Worker API 자체를 무력화 (강제 비활성화)
    if ('serviceWorker' in navigator) {
      Object.defineProperty(navigator, 'serviceWorker', {
        get: function () {
          console.log('Service Worker API blocked for HTTP environment');
          return undefined;
        }
      });
    }

    // 3. Flutter 설정으로 Service Worker 비활성화 + HTML 렌더러 강제
    window.flutterConfiguration = {
      serviceWorkerVersion: null,
      // ✅ CanvasKit 대신 HTML 렌더러 사용 (HTTP 환경 호환)
      renderer: "html",
    };

    // 4. ✅ 윈도우 리사이즈 감지 후 강제 재빌드 (Flutter Web viewport 버그 방지)
    window.addEventListener('resize', function () {
      // 인라인 스타일 제거하고 CSS 규칙이 적용되도록 함
      const html = document.documentElement;
      const flutterView = document.querySelector('flutter-view');

      // HTML과 Flutter 뷰의 인라인 스타일 제거
      html.style.removeProperty('height');
      html.style.removeProperty('width');
      if (flutterView) {
        flutterView.style.removeProperty('height');
        flutterView.style.removeProperty('width');
      }

      console.log(`📐 Window resized: ${window.innerWidth}x${window.innerHeight}`);
      window.dispatchEvent(new Event('flutter-resize'));
    });

    // 초기 로드 시에도 한 번 실행
    window.addEventListener('load', function () {
      // 인라인 스타일 제거하고 CSS 규칙이 적용되도록 함
      const html = document.documentElement;
      const flutterView = document.querySelector('flutter-view');

      // HTML과 Flutter 뷰의 인라인 스타일 제거
      html.style.removeProperty('height');
      html.style.removeProperty('width');
      if (flutterView) {
        flutterView.style.removeProperty('height');
        flutterView.style.removeProperty('width');
      }

      console.log(`📐 Initial size: ${window.innerWidth}x${window.innerHeight}`);
      window.dispatchEvent(new Event('flutter-resize'));
    });

    // 5. ✅ 주기적으로 인라인 스타일 제거 (Flutter가 다시 설정하는 경우 대비)
    setInterval(function () {
      const html = document.documentElement;
      const flutterView = document.querySelector('flutter-view');

      if (html.style.height || html.style.width) {
        console.log('🔧 Removing HTML inline styles');
        html.style.removeProperty('height');
        html.style.removeProperty('width');
      }

      if (flutterView && (flutterView.style.height || flutterView.style.width)) {
        console.log('🔧 Removing Flutter view inline styles');
        flutterView.style.removeProperty('height');
        flutterView.style.removeProperty('width');
      }
    }, 100); // 0.1초마다 체크 (더 자주)

    // 6. ✅ Flutter 로드 완료 후 강제 스타일 적용
    window.addEventListener('flutter-first-frame', function () {
      console.log('🎬 Flutter first frame loaded, applying responsive styles');
      const html = document.documentElement;
      const flutterView = document.querySelector('flutter-view');

      // 모든 인라인 스타일 제거
      html.style.removeProperty('height');
      html.style.removeProperty('width');
      if (flutterView) {
        flutterView.style.removeProperty('height');
        flutterView.style.removeProperty('width');
      }

      // CSS 규칙 강제 적용
      html.style.setProperty('width', '100vw', 'important');
      html.style.setProperty('height', '100vh', 'important');
      if (flutterView) {
        flutterView.style.setProperty('width', '100vw', 'important');
        flutterView.style.setProperty('height', '100vh', 'important');
      }
    });
  </script>
</head>

<body>
  <!-- ✅ HTML 렌더러 강제 설정 (flutter_bootstrap.js 로드 전에 실행) -->
  <script>
    // 🔥 CanvasKit 완전 차단 - HTML 렌더러만 사용
    if (!window.flutterConfiguration) {
      window.flutterConfiguration = {};
    }
    window.flutterConfiguration.renderer = "html";
    window.flutterConfiguration.canvasKitBaseUrl = null;  // CanvasKit 로드 차단
    console.log('🔒 Forced HTML renderer, CanvasKit blocked');
  </script>
  <!-- ✅ HTML 렌더러 명시적 지정 (CanvasKit WebGL 충돌 방지) -->
  <script src="flutter_bootstrap.js" data-renderer="html"></script>
</body>

</html>