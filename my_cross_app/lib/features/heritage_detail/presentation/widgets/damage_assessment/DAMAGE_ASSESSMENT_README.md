# 손상 평가 모듈 (Damage Assessment Summary)

## 개요

손상부 종합 모듈은 구성 요소별 O/X 손상표를 입력하고, 자동으로 손상 등급을 계산하여 표시하는 기능을 제공합니다.

## 주요 기능

### 1. O/X 편집 가능 테이블
- 구성 요소별 손상 유형별 O/X 입력
- 실시간 입력 검증 (O, X, /, 공백만 허용)
- 자동 대문자 변환
- 가로/세로 스크롤 지원
- 고정 헤더

### 2. 자동 등급 계산
- **육안 등급**: 손상 카테고리 수와 주요 그룹을 기반으로 A~D 등급 자동 계산
- **심화 등급**: 구조적 손상을 우선 고려한 더 엄격한 등급 계산
- O/X 변경 시 실시간 재계산

### 3. 등급 테이블
- 육안/심화 등급 표시
- 색상 코딩 (A: 녹색, B: 연두, C: 노랑, D: 주황)
- 수동 오버라이드 모드 지원

### 4. Firestore 통합
- 자동 저장 (300ms 디바운싱)
- 실시간 동기화
- 오류 처리 및 재시도

## 비즈니스 로직

### 육안 등급 계산 규칙

1. **A 등급**: 모든 카테고리가 X (손상 없음)
2. **B 등급**: 1개 카테고리만 O (경미한 손상)
3. **C 등급**: 2개 이상 카테고리 O
4. **D 등급**: 
   - 3개 이상 O 컬럼
   - 또는 2개 이상 주요 그룹(구조+물리 등)에 손상

### 심화 등급 계산 규칙

1. **구조적 손상 있음**:
   - 구조 + 물리 또는 구조 + 생화학 → **D**
   - 구조적 손상만 → **C**

2. **구조적 손상 없음**:
   - 물리/생화학 손상 2개 이상 → **C**
   - 경미한 물리/생화학만 → **B**
   - 손상 없음 → **A**

## 데이터 구조

### Firestore 문서 구조

```
heritages/{heritageId}/detail_surveys/damage_assessment_summary
{
  "oxTable": {
    "component_1": {
      "componentId": "component_1",
      "componentName": "기둥 02번 (서)",
      "oxValues": {
        "이격/이완": "O/X/O",
        "기울": "O/O/O",
        "탈락": "X/O/X",
        ...
      }
    },
    ...
  },
  "grades": {
    "component_1": {
      "componentId": "component_1",
      "visualGrade": "C",
      "advancedGrade": "D",
      "lastUpdated": "2024-01-15T10:30:00Z",
      "isManualOverride": false
    },
    ...
  },
  "autoGradeEnabled": true,
  "updatedAt": Timestamp,
  "createdAt": Timestamp
}
```

## 사용 예시

### 예시 1: 기본 사용

```dart
DamageAssessmentSection(
  heritageId: 'heritage_123',
  sectionNumber: 1,
)
```

### 예시 2: 테스트 데이터

**입력**:
- 구성 요소: "기둥 02번 (서)"
- 이격/이완: O/X/O
- 기울: O/O/O
- 탈락: X/O/X
- 갈램: X/O/O
- 천공: X/O/X
- 부후: X/O/O

**계산 결과**:
- 육안 등급: **C** (2개 이상 카테고리 손상)
- 심화 등급: **D** (구조적 손상 + 물리적/생화학적 손상)

### 예시 3: 경미한 손상

**입력**:
- 구성 요소: "기둥 18번 (남)"
- 갈램: O/O/O (물리적 손상만)

**계산 결과**:
- 육안 등급: **B** (1개 카테고리만 손상)
- 심화 등급: **B** (구조적 손상 없음, 경미한 물리적 손상)

## 테스트 케이스

### 케이스 1: 손상 없음
```
입력: 모든 컬럼 X/X/X
예상 결과: 육안 A, 심화 A
```

### 케이스 2: 경미한 손상
```
입력: 갈램만 O/O/O, 나머지 X/X/X
예상 결과: 육안 B, 심화 B
```

### 케이스 3: 중간 손상
```
입력: 이격/이완 O/X/O, 기울 O/O/O
예상 결과: 육안 C, 심화 C
```

### 케이스 4: 심각한 손상
```
입력: 이격/이완 O/O/O, 기울 O/O/O, 갈램 O/O/O, 부후 O/O/O
예상 결과: 육안 D, 심화 D
```

## 파일 구조

```
damage_assessment/
├── damage_assessment_models.dart      # 데이터 모델
├── damage_grade_calculator.dart       # 등급 계산 로직
├── damage_ox_table.dart               # O/X 편집 테이블
├── damage_grade_table.dart            # 등급 표시 테이블
└── damage_assessment_section.dart     # 통합 위젯
```

## 주의사항

1. **입력 검증**: O, X, /, 공백만 허용됩니다. 다른 문자 입력 시 빨간색으로 표시됩니다.
2. **자동 저장**: 입력 후 300ms 후 자동 저장됩니다.
3. **등급 계산**: 자동 등급 모드에서는 수동 변경이 불가능합니다.
4. **오프라인**: Firestore 연결 실패 시 로컬에 캐시되고 재시도됩니다.

## 향후 개선 사항

- [ ] 구성 요소 이름 편집 기능
- [ ] 컬럼 추가/삭제 기능
- [ ] 등급 히스토리 추적
- [ ] PDF 내보내기
- [ ] 엑셀 내보내기

