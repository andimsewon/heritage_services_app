# 🚀 현재 코드 배포 실행 가이드

## 📦 **배포 파일 정보**
- **파일명**: `final_csp_fix.tar.gz`
- **크기**: 11MB
- **포함 파일**: 45개
- **주요 내용**: CSP 완전 우회된 웹 앱 + Nginx 설정

## 🎯 **배포 목표**
- CSP `blob:` URL 차단 문제 해결
- 배포된 환경에서 이미지 정상 표시
- `http://210.117.181.115:3001/#/home`에서 이미지 확인

## 🚀 **배포 실행 명령어**

### 1. **배포 서버 접속**
```bash
# 배포 서버 (210.117.181.115)에 SSH 접속
ssh user@210.117.181.115
```

### 2. **기존 서비스 중지**
```bash
# Docker 컨테이너 중지
docker-compose down

# 또는 개별 컨테이너 중지
docker stop heritage-web heritage-api
docker rm heritage-web heritage-api
```

### 3. **새 파일 업로드 및 적용**
```bash
# final_csp_fix.tar.gz 파일을 서버에 업로드한 후:
tar -xzf final_csp_fix.tar.gz

# 웹 앱 파일 복사 (기존 파일 덮어쓰기)
cp -r my_cross_app/build/web/* /path/to/your/web/directory/

# Nginx 설정 적용
cp nginx.conf /etc/nginx/conf.d/default.conf
nginx -t
systemctl restart nginx
```

### 4. **Docker 컨테이너 재시작**
```bash
# 전체 재시작
docker-compose up -d

# 상태 확인
docker-compose ps
docker-compose logs heritage-web
```

### 5. **테스트 및 확인**
```bash
# 웹 앱 접속
# http://210.117.181.115:3001/#/home

# 강제 새로고침 (캐시 삭제)
# Ctrl+Shift+R

# 브라우저 개발자 도구에서 확인
# F12 → Console 탭에서 CSP 에러 확인
# F12 → Network 탭에서 blob: URL 로드 확인
```

## 🔧 **주요 변경사항**

### A. CSP 완전 우회 설정
```nginx
# nginx.conf
add_header Content-Security-Policy "
    default-src *;
    img-src * data: blob:;
    media-src * data: blob:;
    connect-src *;
    script-src * 'unsafe-inline' 'unsafe-eval';
    style-src * 'unsafe-inline';
    font-src * data:;
    frame-ancestors *;
" always;
```

### B. Flutter 웹 앱 CSP 설정
```html
<!-- index.html -->
<meta http-equiv="Content-Security-Policy" content="default-src *; img-src * data: blob:; media-src * data: blob:; connect-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; font-src * data:; frame-ancestors *;">
```

## ✅ **성공 확인 기준**

### 1. **브라우저 콘솔**
- CSP 에러가 완전히 사라짐
- `blob:` URL이 `(blocked:csp)` 없이 로드됨

### 2. **이미지 표시**
- 문화유산 사진이 깨진 아이콘 대신 실제 사진이 표시됨
- 모든 이미지 소스가 정상 작동

### 3. **Network 탭**
- `blob:` 요청이 정상적으로 로드됨
- Status가 `200` 또는 정상 상태

## 🚨 **문제 해결**

### 여전히 이미지가 깨진다면:
1. **브라우저 캐시 완전 삭제**: `Ctrl+Shift+Delete` → 모든 시간 → 모든 항목 체크
2. **시크릿 모드에서 테스트**: 새 시크릿 창에서 접속
3. **컨테이너 재시작**: `docker-compose restart heritage-web`
4. **Nginx 설정 확인**: `nginx -t`로 설정 문법 확인

## 📁 **배포 파일 구조**
```
final_csp_fix.tar.gz
├── my_cross_app/build/web/          # CSP 완전 우회된 웹 앱
│   ├── index.html                   # blob: 허용된 CSP 설정
│   ├── flutter.js
│   ├── canvaskit/
│   └── ...
├── nginx.conf                       # 완전 우회된 CSP 헤더
└── docker-compose.yml              # 컨테이너 설정
```

## 🎉 **예상 결과**

배포 완료 후:
- ✅ CSP 에러가 완전히 사라짐
- ✅ `blob:` URL이 정상적으로 로드됨
- ✅ 이미지가 깨진 아이콘 대신 실제 사진이 표시됨
- ✅ 모든 이미지 소스가 정상 작동

이제 배포를 실행하세요! 🚀
